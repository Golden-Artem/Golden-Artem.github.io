<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>D&D Map Maker — 0.7.2</title>
<script src="https://unpkg.com/konva@9.3.1/konva.min.js"></script>
<style>
  :root { --left:200px; --right:260px; }
  html,body { margin:0; height:100%; background:#222; color:#eee; font-family:Arial,sans-serif; }
  .layout { display:flex; height:100vh; }
  .panel { background:#333; padding:10px; box-sizing:border-box; overflow:auto; }
  .left  { width:var(--left); }
  .right { width:var(--right); }
  #container { flex:1; background:#444; cursor:grab; }

  h3 { margin:6px 0; font-size:15px; }
  .asset, .objItem {
    padding:6px; margin-bottom:8px;
    background:#4b4b4b; border:1px solid #555; border-radius:6px; cursor:pointer;
  }
  .asset img.thumb{max-width:100%;height:auto;display:block;margin-top:4px;}
  .asset:hover { background:#5f5f5f; }
  .objItem.active { background:#c8b56a; color:#000; }

  button, input[type=file] {
    width:100%; padding:8px; margin-top:8px;
    border:0; background:#5a5a5a; color:#fff; border-radius:6px; cursor:pointer;
  }
  button:hover, input[type=file]:hover { background:#777; }
  .info { font-size:12px; color:#ccc; margin-top:8px; }

  /* ---- персонажи ---- */
  #charList { margin-top:8px; }
  .charRow {
    display:flex;
    flex-wrap:wrap;          /* переносятся строки */
    gap:6px;
    align-items:center;
    background:#4b4b4b;
    padding:6px;
    border-radius:6px;
    margin-bottom:8px;
  }
  .charRow img {
    width:40px;height:40px;border-radius:4px;object-fit:cover;cursor:pointer;
  }
  .charRow label { font-size:12px; }
  .charRow input[type=number] {
    flex:1 1 60px;
    max-width:70px;
    padding:4px;
    border:0;
    border-radius:4px;
    background:#555;
    color:#fff;
  }
  .charRow input[type=text] {
    flex:1 1 100%;
    max-width:120px;
    padding:4px;
    border:0;
    border-radius:4px;
    background:#555;
    color:#fff;
  }
  .diceBtn { width:48px; margin:2px; }
  #diceResult { margin-top:6px; font-weight:bold; text-align:center; }
</style>
</head>
<body>
<div class="layout">

  <!-- Левая панель -->
  <div class="panel left">
    <h3>Ассеты</h3>
    <div id="assetList"></div>
    <input id="fileInput" type="file" accept="image/*">
    <button id="savePngBtn">Сохранить карту (PNG)</button>
    <button id="saveJsonBtn">Сохранить проект (JSON)</button>
    <input id="loadJson" type="file" accept="application/json">
  </div>

  <!-- Центральное поле -->
  <div id="container"></div>

  <!-- Правая панель -->
  <div class="panel right">
    <h3>Объекты</h3>
    <div id="objects"></div>
    <button id="deleteBtn">Удалить выбранный</button>
    <button id="copyBtn">Копировать выбранный</button>
    <button id="mirrorBtn">Отзеркалить по горизонтали</button>
    <button id="layerUpBtn">Вперёд (выше)</button>
    <button id="layerDownBtn">Назад (ниже)</button>

    <h3 style="margin-top:14px;">Фон</h3>
    <input id="bgFile" type="file" accept="image/*">

    <h3 style="margin-top:14px;">Персонажи</h3>
    <input id="addCharImg" type="file" accept="image/*">
    <div id="charList"></div>

    <h3 style="margin-top:14px;">Кубики</h3>
    <div>
      <button class="diceBtn" onclick="roll(4)">d4</button>
      <button class="diceBtn" onclick="roll(6)">d6</button>
      <button class="diceBtn" onclick="roll(8)">d8</button>
      <button class="diceBtn" onclick="roll(12)">d12</button>
      <button class="diceBtn" onclick="roll(20)">d20</button>
    </div>
    <div id="diceResult">–</div>

    <div class="info">
      • ЛКМ по пустому — перетаскивание карты<br>
      • Колёсико — масштаб сцены или объекта<br>
      • Клик по объекту — выделение/снятие<br>
      • Углы — изменение размера, кружок сверху — поворот
    </div>
  </div>

</div>

<script>
/* ---------- Ассеты ---------- */
const assets = [
  {name:'Деревянный дом', url:'assets/wood_house.png'},
  {name:'Каменный дом',   url:'assets/stone_house.png'},
  {name:'Замок',          url:'assets/castle.png'},
  {name:'Таверна',        url:'assets/tavern.png'},
  {name:'Гильдия',        url:'assets/guild.png'},
  {name:'Лес',            url:'assets/forest.png'},
  {name:'Поляна',         url:'assets/clearing.png'},
  {name:'Вход в подземелье', url:'assets/dungeon_entrance.png'},
  {name:'Комната подземелья', url:'assets/dungeon_room.png'},
  {name:'Сундук',            url:'assets/dungeon_chest.png'},
  {name:'Факел',             url:'assets/dungeon_torch.png'},
  {name:'Руины',             url:'assets/dungeon_rocks.png'},
  {name:'Каменная тропинка',  url:'assets/stone_path.png'},
  {name:'Земляная тропинка',  url:'assets/earth_path.png'}
];

/* ---------- Сцена ---------- */
const stage = new Konva.Stage({
  container: 'container',
  width: window.innerWidth - (200 + 260),
  height: window.innerHeight
});
const backgroundLayer = new Konva.Layer();
const gridLayer = new Konva.Layer();
const objectLayer = new Konva.Layer();
stage.add(backgroundLayer);
stage.add(gridLayer);
stage.add(objectLayer);

/* Сетка */
function drawGrid(cell=48){
  gridLayer.destroyChildren();
  const w=stage.width(), h=stage.height();
  for(let i=0;i<=w/cell;i++){
    gridLayer.add(new Konva.Line({
      points:[i*cell,0,i*cell,h],
      stroke:'rgba(255,255,255,0.25)', strokeWidth:1
    }));
  }
  for(let j=0;j<=h/cell;j++){
    gridLayer.add(new Konva.Line({
      points:[0,j*cell,w,j*cell],
      stroke:'rgba(255,255,255,0.25)', strokeWidth:1
    }));
  }
  gridLayer.batchDraw();
}
drawGrid();

/* UI ассетов */
const assetList=document.getElementById('assetList');
assets.forEach(a=>{
  const d=document.createElement('div');
  d.className='asset';
  d.innerHTML=`<strong>${a.name}</strong><img class="thumb" src="${a.url}">`;
  d.onclick=()=>addAsset(a.url,a.name);
  assetList.appendChild(d);
});

/* Объекты */
let objectsData=[], selectedId=null, idCounter=1;
const transformer = new Konva.Transformer({
  rotateEnabled:true,
  enabledAnchors:[
    'top-left','top-center','top-right',
    'middle-right','bottom-right','bottom-center',
    'bottom-left','middle-left'
  ],
  boundBoxFunc:(oldBox,newBox)=>{
    if(newBox.width<16||newBox.height<16) return oldBox;
    return newBox;
  }
});
objectLayer.add(transformer);

function addAsset(url,name,x=null,y=null,extra={}) {
  Konva.Image.fromURL(url,img=>{
    const w=img.width()||64, h=img.height()||64;
    const id='obj_'+Date.now()+'_'+(idCounter++);
    img.setAttrs({
      x: x ?? stage.width()/2 - w/4,
      y: y ?? stage.height()/2 - h/4,
      width: w/2,
      height: h/2,
      draggable: true,
      id,
      ...extra
    });
    img.on('click',e=>{ e.cancelBubble=true; toggleSelect(id); });
    img.on('dragend transformend',refreshObjectList);
    objectLayer.add(img);
    objectsData.push({id,name,url,node:img});
    selectObject(id);
    refreshObjectList();
  });
}

const objectsDiv=document.getElementById('objects');
function refreshObjectList(){
  objectsDiv.innerHTML='';
  objectsData.forEach(o=>{
    const div=document.createElement('div');
    div.className='objItem'+(o.id===selectedId?' active':'');
    div.textContent=o.name;
    div.onclick=()=>toggleSelect(o.id);
    objectsDiv.appendChild(div);
  });
}

function selectObject(id){
  selectedId=id;
  transformer.nodes([objectsData.find(o=>o.id===id).node]);
  objectLayer.batchDraw();
  refreshObjectList();
}
function toggleSelect(id){ selectedId===id ? deselect() : selectObject(id); }
function deselect(){ selectedId=null; transformer.nodes([]); objectLayer.batchDraw(); refreshObjectList(); }
stage.on('mousedown',e=>{ if(e.target===stage||e.target===backgroundLayer||e.target===gridLayer) deselect(); });

/* Удаление */
deleteBtn.onclick=()=>{
  if(!selectedId) return;
  const i=objectsData.findIndex(o=>o.id===selectedId);
  if(i>=0){ objectsData[i].node.destroy(); objectsData.splice(i,1); deselect(); refreshObjectList(); }
};

/* Копирование */
copyBtn.onclick=()=>{
  if(!selectedId) return;
  const obj=objectsData.find(o=>o.id===selectedId);
  if(!obj) return;
  const n=obj.node;
  const pos=stage.getPointerPosition() || {x:n.x()+20,y:n.y()+20};
  addAsset(obj.url, obj.name+' (копия)', pos.x, pos.y, {
    width: n.width(),
    height: n.height(),
    scaleX: n.scaleX(),
    scaleY: n.scaleY(),
    rotation: n.rotation()
  });
};

/* Зеркалирование */
mirrorBtn.onclick=()=>{
  if(!selectedId) return;
  const obj=objectsData.find(o=>o.id===selectedId);
  obj.node.scaleX(obj.node.scaleX()*-1);
  objectLayer.batchDraw();
};

/* --- Слои --- */
layerUpBtn.onclick=()=>{
  if(!selectedId) return;
  const obj=objectsData.find(o=>o.id===selectedId);
  obj.node.moveUp();
  objectLayer.batchDraw();
};
layerDownBtn.onclick=()=>{
  if(!selectedId) return;
  const obj=objectsData.find(o=>o.id===selectedId);
  obj.node.moveDown();
  objectLayer.batchDraw();
};

/* Масштабирование */
stage.on('wheel',e=>{
  e.evt.preventDefault();
  const ptr=stage.getPointerPosition();
  if(selectedId){
    const t=objectsData.find(o=>o.id===selectedId);
    if(t && stage.getIntersection(ptr)===t.node){
      const k=e.evt.deltaY>0?0.9:1.1;
      const s=t.node.scaleX()*k;
      if(s>0.1 && s<10){ t.node.scale({x:s,y:s}); objectLayer.batchDraw(); }
      return;
    }
  }
  const scaleBy=1.1;
  const old=stage.scaleX();
  const mp={x:(ptr.x-stage.x())/old,y:(ptr.y-stage.y())/old};
  const dir=e.evt.deltaY>0?-1:1;
  const newS=dir>0?old*scaleBy:old/scaleBy;
  stage.scale({x:newS,y:newS});
  stage.position({x:ptr.x-mp.x*newS,y:ptr.y-mp.y*newS});
  stage.batchDraw();
});

/* Панорамирование сцены */
let isPanning=false,lastPos=null;
const cont=document.getElementById('container');
cont.addEventListener('mousedown',e=>{
  const target=stage.getIntersection(stage.getPointerPosition());
  if(!target){
    isPanning=true;
    cont.style.cursor='grabbing';
    lastPos={x:e.clientX,y:e.clientY};
  }
});
cont.addEventListener('mousemove',e=>{
  if(!isPanning) return;
  const dx=e.clientX-lastPos.x, dy=e.clientY-lastPos.y;
  lastPos={x:e.clientX,y:e.clientY};
  stage.position({x:stage.x()+dx, y:stage.y()+dy});
  stage.batchDraw();
});
cont.addEventListener('mouseup',()=>{isPanning=false; cont.style.cursor='grab';});
cont.addEventListener('mouseleave',()=>{isPanning=false; cont.style.cursor='grab';});

/* Загрузка своих ассетов */
fileInput.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>addAsset(ev.target.result,f.name);
  r.readAsDataURL(f);
  e.target.value='';
};

/* Сохранение карты как PNG */
savePngBtn.onclick=()=>{
  const uri=stage.toDataURL({pixelRatio:2});
  const a=document.createElement('a'); a.href=uri; a.download='dnd_map.png'; a.click();
};

/* --- Сохранение/загрузка проекта (JSON) --- */
saveJsonBtn.onclick=()=>{
  const data = {
    stage: { x: stage.x(), y: stage.y(), scale: stage.scaleX() },
    objects: objectsData.map(o=>({
      name: o.name, url: o.url,
      x: o.node.x(), y: o.node.y(),
      width: o.node.width(), height: o.node.height(),
      scaleX: o.node.scaleX(), scaleY: o.node.scaleY(),
      rotation: o.node.rotation(), zIndex: o.node.zIndex()
    }))
  };
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='dnd_project.json';
  a.click();
};

loadJson.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const data = JSON.parse(ev.target.result);
    objectsData.forEach(o=>o.node.destroy());
    objectsData=[];
    deselect();
    data.objects.sort((a,b)=>a.zIndex-b.zIndex).forEach(obj=>{
      addAsset(obj.url, obj.name, obj.x, obj.y, {
        width: obj.width,
        height: obj.height,
        scaleX: obj.scaleX,
        scaleY: obj.scaleY,
        rotation: obj.rotation
      });
    });
    stage.position({x:data.stage.x, y:data.stage.y});
    stage.scale({x:data.stage.scale, y:data.stage.scale});
    stage.batchDraw();
  };
  r.readAsText(f);
  e.target.value='';
};

/* Загрузка пользовательского фона */
bgFile.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    backgroundLayer.destroyChildren();
    Konva.Image.fromURL(ev.target.result, img=>{
      img.setAttrs({x:0,y:0,width:stage.width(),height:stage.height(),listening:false});
      backgroundLayer.add(img);
      backgroundLayer.batchDraw();
      gridLayer.moveToTop();
      gridLayer.batchDraw();
    });
  };
  r.readAsDataURL(f);
  e.target.value='';
};

/* ---- Персонажи ---- */
const charList=document.getElementById('charList');
addCharImg.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const imgUrl=ev.target.result;
    addCharacter(imgUrl);
  };
  r.readAsDataURL(f);
  e.target.value='';
};

function addCharacter(imgUrl){
  // иконка на карте
  Konva.Image.fromURL(imgUrl,img=>{
    const id='char_'+Date.now();
    img.setAttrs({
      x:stage.width()/2-24,
      y:stage.height()/2-24,
      width:48,height:48,
      draggable:true,
      id
    });
    objectLayer.add(img);
    objectsData.push({id,name:'Персонаж',url:imgUrl,node:img});
    refreshObjectList();
  });

  // панель управления
  const row=document.createElement('div');
  row.className='charRow';
  row.innerHTML=`
    <img src="${imgUrl}" title="Клик для замены">
    <input type="text" value="Персонаж">
    <label>HP</label><input type="number" value="10">
    <label>КД</label><input type="number" value="12">
    <label>Скорость</label><input type="number" value="30">
    <button onclick="adjustHP(this,-1)">-1</button>
    <button onclick="adjustHP(this,1)">+1</button>
  `;
  // замена картинки
  const imgTag=row.querySelector('img');
  imgTag.onclick=()=>{
    const inp=document.createElement('input');
    inp.type='file'; inp.accept='image/*';
    inp.onchange=ev=>{
      const f=ev.target.files[0];
      if(!f) return;
      const r=new FileReader();
      r.onload=fr=>{
        imgTag.src=fr.target.result;
        // обновить спрайт на карте
        const obj=objectsData.find(o=>o.url===imgUrl);
        if(obj){
          obj.node.image().src=fr.target.result;
          obj.node.getLayer().batchDraw();
          obj.url=fr.target.result;
        }
      };
      r.readAsDataURL(f);
    };
    inp.click();
  };
  charList.appendChild(row);
}

function adjustHP(btn,delta){
  const hpInput=btn.parentElement.querySelector('input[type=number]');
  hpInput.value=parseInt(hpInput.value)+delta;
}

/* ---- Кубики ---- */
function roll(sides){
  const val = 1 + Math.floor(Math.random()*sides);
  document.getElementById('diceResult').textContent = 'Результат: d'+sides+' → '+val;
}

/* Ресайз окна */
window.addEventListener('resize',()=>{
  stage.width(window.innerWidth - (200 + 260));
  stage.height(window.innerHeight);
  backgroundLayer.getChildren().forEach(img=>{
    img.width(stage.width());
    img.height(stage.height());
  });
  backgroundLayer.batchDraw();
  drawGrid();
});
</script>
</body>
</html>
