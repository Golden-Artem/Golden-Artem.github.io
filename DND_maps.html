<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>D&D Map Maker - 0.6.8</title>
<script src="https://unpkg.com/konva@9.3.1/konva.min.js"></script>
<style>
  :root { --left:220px; --right:250px; }
  html,body { margin:0; height:100%; background:#222; color:#eee; font-family:Arial,sans-serif; }
  .layout { display:flex; height:100vh; }
  .panel { background:#333; padding:10px; box-sizing:border-box; overflow:auto; }
  .left  { width:var(--left); }
  .right { width:var(--right); }
  #container { flex:1; background:#444; cursor:grab; }

  h3 { margin:6px 0; font-size:15px; }
  .asset { padding:6px; margin-bottom:8px; background:#4b4b4b; border:1px solid #555; border-radius:6px; cursor:pointer; }
  .asset:hover { background:#5f5f5f; }
  .thumb { width:100%; height:auto; margin-top:6px; border-radius:4px; }

  .objItem { padding:6px; margin-bottom:6px; background:#4b4b4b; border:1px solid #555; border-radius:6px; cursor:pointer; }
  .objItem.active { background:#c8b56a; color:#000; }

  button, input[type=file], select {
    width:100%; padding:8px; margin-top:8px;
    border:0; background:#5a5a5a; color:#fff; border-radius:6px; cursor:pointer;
  }
  button:hover, input[type=file]:hover, select:hover { background:#777; }

  .info { font-size:12px; color:#ccc; margin-top:8px; }
</style>
</head>
<body>
<div class="layout">

  <!-- Левая панель -->
  <div class="panel left">
    <h3>Ассеты</h3>
    <div id="assetList"></div>
    <input id="fileInput" type="file" accept="image/*">
    <button id="saveBtn">Сохранить карту (PNG)</button>

    <h3 style="margin-top:12px;">Тропинка</h3>
    <select id="brushType">
      <option value="stone">Каменная</option>
      <option value="earth">Земляная</option>
    </select>
    Толщина: <span id="bwVal">32</span> px
    <input id="bw" type="range" min="8" max="100" value="32">
    <button id="toggleBrush">Включить кисть</button>
    <button id="clearPaths">Очистить тропинки</button>
  </div>

  <!-- Центральное поле -->
  <div id="container"></div>

  <!-- Правая панель -->
  <div class="panel right">
    <h3>Объекты</h3>
    <div id="objects"></div>
    <button id="deleteBtn">Удалить выбранный</button>
    <button id="copyBtn">Копировать выбранный</button>
    <button id="mirrorBtn">Отзеркалить по горизонтали</button>

    <h3 style="margin-top:14px;">Фон</h3>
    <input id="bgFile" type="file" accept="image/*">

    <div class="info">
      • ЛКМ по пустому — перетаскивание карты (если кисть выключена)<br>
      • Колёсико вне объекта — масштаб карты<br>
      • Колёсико на объекте — масштаб объекта<br>
      • Клик по объекту — выделение/снятие<br>
      • Углы — изменение размера, кружок сверху — поворот<br>
      • В режиме кисти ЛКМ рисует тропинку
    </div>
  </div>

</div>

<script>
/* ---------- Ассеты ---------- */
const assets = [
  {name:'Деревянный дом', url:'assets/wood_house.png'},
  {name:'Каменный дом',   url:'assets/stone_house.png'},
  {name:'Замок',          url:'assets/castle.png'},
  {name:'Таверна',        url:'assets/tavern.png'},
  {name:'Гильдия',        url:'assets/guild.png'},
  {name:'Лес',            url:'assets/forest.png'},
  {name:'Поляна',         url:'assets/clearing.png'},
  {name:'Вход в подземелье', url:'assets/dungeon_entrance.png'},
  {name:'Комната подземелья', url:'assets/dungeon_room.png'},
  {name:'Сундук',            url:'assets/dungeon_chest.png'},
  {name:'Факел',             url:'assets/dungeon_torch.png'},
  {name:'Руины',             url:'assets/dungeon_rocks.png'},
  {name:'Каменная тропинка', url:'assets/stone_path.png'},
  {name:'Земляная тропинка', url:'assets/earth_path.png'}
];

/* ---------- Сцена ---------- */
const stage = new Konva.Stage({
  container: 'container',
  width: window.innerWidth - (220 + 250),
  height: window.innerHeight
});
const backgroundLayer = new Konva.Layer();
const gridLayer = new Konva.Layer();
const pathLayer = new Konva.Layer();   // слой для тропинок
const objectLayer = new Konva.Layer();
stage.add(backgroundLayer);
stage.add(gridLayer);
stage.add(pathLayer);
stage.add(objectLayer);

/* Сетка */
function drawGrid(cell=48){
  gridLayer.destroyChildren();
  const w=stage.width(), h=stage.height();
  for(let i=0;i<=w/cell;i++){
    gridLayer.add(new Konva.Line({
      points:[i*cell,0,i*cell,h],
      stroke:'rgba(255,255,255,0.25)', strokeWidth:1
    }));
  }
  for(let j=0;j<=h/cell;j++){
    gridLayer.add(new Konva.Line({
      points:[0,j*cell,w,j*cell],
      stroke:'rgba(255,255,255,0.25)', strokeWidth:1
    }));
  }
  gridLayer.batchDraw();
}
drawGrid();

/* UI ассетов */
const assetList=document.getElementById('assetList');
assets.forEach(a=>{
  const d=document.createElement('div');
  d.className='asset';
  d.innerHTML=`<strong>${a.name}</strong><img class="thumb" src="${a.url}">`;
  d.onclick=()=>addAsset(a.url,a.name);
  assetList.appendChild(d);
});

/* Объекты */
let objectsData=[], selectedId=null, idCounter=1;
const transformer = new Konva.Transformer({
  rotateEnabled:true,
  enabledAnchors:[
    'top-left','top-center','top-right',
    'middle-right','bottom-right','bottom-center',
    'bottom-left','middle-left'
  ],
  boundBoxFunc:(oldBox,newBox)=>{
    if(newBox.width<16||newBox.height<16) return oldBox;
    return newBox;
  }
});
objectLayer.add(transformer);

function addAsset(url,name,x=null,y=null,extra={}) {
  Konva.Image.fromURL(url,img=>{
    const w=img.width()||64, h=img.height()||64;
    const id='obj_'+Date.now()+'_'+(idCounter++);
    img.setAttrs({
      x: x ?? stage.width()/2 - w/4,
      y: y ?? stage.height()/2 - h/4,
      width: w/2,
      height: h/2,
      draggable: true,
      id,
      ...extra
    });
    img.on('click',e=>{ e.cancelBubble=true; toggleSelect(id); });
    img.on('dragend transformend',refreshObjectList);
    objectLayer.add(img);
    objectsData.push({id,name,url,node:img});
    selectObject(id);
    refreshObjectList();
  });
}

const objectsDiv=document.getElementById('objects');
function refreshObjectList(){
  objectsDiv.innerHTML='';
  objectsData.forEach(o=>{
    const div=document.createElement('div');
    div.className='objItem'+(o.id===selectedId?' active':'');
    div.textContent=o.name;
    div.onclick=()=>toggleSelect(o.id);
    objectsDiv.appendChild(div);
  });
}
function selectObject(id){
  selectedId=id;
  transformer.nodes([objectsData.find(o=>o.id===id).node]);
  objectLayer.batchDraw();
  refreshObjectList();
}
function toggleSelect(id){ selectedId===id ? deselect() : selectObject(id); }
function deselect(){ selectedId=null; transformer.nodes([]); objectLayer.batchDraw(); refreshObjectList(); }

/* Удаление/копирование/зеркалирование */
document.getElementById('deleteBtn').onclick=()=>{
  if(!selectedId) return;
  const i=objectsData.findIndex(o=>o.id===selectedId);
  if(i>=0){ objectsData[i].node.destroy(); objectsData.splice(i,1); deselect(); refreshObjectList(); }
};
document.getElementById('copyBtn').onclick=()=>{
  if(!selectedId) return;
  const obj=objectsData.find(o=>o.id===selectedId);
  if(!obj) return;
  const n=obj.node;
  const pos=stage.getPointerPosition() || {x:n.x()+20,y:n.y()+20};
  addAsset(obj.url, obj.name+' (копия)', pos.x, pos.y, {
    width: n.width(),
    height: n.height(),
    scaleX: n.scaleX(),
    scaleY: n.scaleY(),
    rotation: n.rotation()
  });
};
document.getElementById('mirrorBtn').onclick=()=>{
  if(!selectedId) return;
  const obj=objectsData.find(o=>o.id===selectedId);
  if(!obj) return;
  obj.node.scaleX(obj.node.scaleX()*-1);
  objectLayer.batchDraw();
};

/* Масштаб: объект или сцена */
stage.on('wheel',e=>{
  e.evt.preventDefault();
  const ptr=stage.getPointerPosition();
  if(selectedId){
    const t=objectsData.find(o=>o.id===selectedId);
    if(t && stage.getIntersection(ptr)===t.node){
      const k=e.evt.deltaY>0?0.9:1.1;
      const s=t.node.scaleX()*k;
      if(s>0.1 && s<10){ t.node.scale({x:s,y:s}); objectLayer.batchDraw(); }
      return;
    }
  }
  const scaleBy=1.1;
  const old=stage.scaleX();
  const mp={x:(ptr.x-stage.x())/old,y:(ptr.y-stage.y())/old};
  const dir=e.evt.deltaY>0?-1:1;
  const newS=dir>0?old*scaleBy:old/scaleBy;
  stage.scale({x:newS,y:newS});
  stage.position({x:ptr.x-mp.x*newS,y:ptr.y-mp.y*newS});
  stage.batchDraw();
});

/* Панорамирование сцены (только когда кисть выключена) */
let isPanning=false,lastPos=null;
const cont=document.getElementById('container');
cont.addEventListener('mousedown',e=>{
  if(brushEnabled) return;
  const target=stage.getIntersection(stage.getPointerPosition());
  if(!target){
    isPanning=true;
    cont.style.cursor='grabbing';
    lastPos={x:e.clientX,y:e.clientY};
  }
});
cont.addEventListener('mousemove',e=>{
  if(!isPanning) return;
  const dx=e.clientX-lastPos.x, dy=e.clientY-lastPos.y;
  lastPos={x:e.clientX,y:e.clientY};
  stage.position({x:stage.x()+dx, y:stage.y()+dy});
  stage.batchDraw();
});
cont.addEventListener('mouseup',()=>{isPanning=false; cont.style.cursor=brushEnabled?'crosshair':'grab';});
cont.addEventListener('mouseleave',()=>{isPanning=false; cont.style.cursor=brushEnabled?'crosshair':'grab';});

/* Загрузка своих ассетов */
document.getElementById('fileInput').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>addAsset(ev.target.result,f.name);
  r.readAsDataURL(f);
  e.target.value='';
};

/* Сохранение карты */
document.getElementById('saveBtn').onclick=()=>{
  const uri=stage.toDataURL({pixelRatio:2});
  const a=document.createElement('a'); a.href=uri; a.download='dnd_map.png'; a.click();
};

/* Загрузка пользовательского фона */
document.getElementById('bgFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    backgroundLayer.destroyChildren();
    Konva.Image.fromURL(ev.target.result, img=>{
      img.setAttrs({x:0,y:0,width:stage.width(),height:stage.height(),listening:false});
      backgroundLayer.add(img);
      backgroundLayer.batchDraw();
      gridLayer.moveToTop();
      gridLayer.batchDraw();
    });
  };
  r.readAsDataURL(f);
  e.target.value='';
};

/* Ресайз окна */
window.addEventListener('resize',()=>{
  stage.width(window.innerWidth - (220 + 250));
  stage.height(window.innerHeight);
  backgroundLayer.getChildren().forEach(img=>{
    img.width(stage.width());
    img.height(stage.height());
  });
  backgroundLayer.batchDraw();
  drawGrid();
});

/* ---------- Кисть тропинка ---------- */
const bwSlider = document.getElementById('bw');
const bwVal = document.getElementById('bwVal');
bwSlider.oninput = ()=> bwVal.textContent = bwSlider.value;

let brushEnabled = false;
document.getElementById('toggleBrush').onclick=()=>{
  brushEnabled = !brushEnabled;
  cont.style.cursor = brushEnabled ? 'crosshair' : 'grab';
  deselect();
  document.getElementById('toggleBrush').textContent = brushEnabled ? 'Выключить кисть' : 'Включить кисть';
};

document.getElementById('clearPaths').onclick=()=>{
  pathLayer.destroyChildren();
  pathLayer.batchDraw();
};

/* Загрузка текстур кисти */
const pathTextures = { stone: new Image(), earth: new Image() };
pathTextures.stone.src = 'assets/stone_path.png';
pathTextures.earth.src = 'assets/earth_path.png';

let drawing = false;
let currentLine = null;
let points = [];

function startLine(pos){
  points = [pos.x, pos.y];
  currentLine = new Konva.Line({
    points,
    closed: true,
    strokeWidth: 0,
    fillPatternImage: pathTextures[document.getElementById('brushType').value],
    listening: false
  });
  pathLayer.add(currentLine);
}

function updateLine(pos){
  const w = parseInt(bwSlider.value);
  const len = points.length/2;
  if(len<2) return;
  const nx = pos.x, ny = pos.y;
  const lx = points[(len-1)*2-2], ly = points[(len-1)*2-1];
  const dx = nx-lx, dy = ny-ly;
  const dist = Math.hypot(dx,dy);
  if(dist < w/4) return;
  const ndx = -dy/dist * w/2;
  const ndy = dx/dist  * w/2;
  points.splice(len*2,0,nx+ndx,ny+ndy);
  points.unshift(nx-ndx,ny-ndy);
  currentLine.points(points);
  pathLayer.batchDraw();
}

stage.on('mousedown', e=>{
  if(!brushEnabled) return;
  drawing = true;
  const p = stage.getPointerPosition();
  startLine(p);
});
stage.on('mousemove', e=>{
  if(!brushEnabled || !drawing) return;
  const p = stage.getPointerPosition();
  updateLine(p);
});
stage.on('mouseup', ()=>{
  if(!brushEnabled) return;
  drawing = false;
  points = [];
  currentLine = null;
});
</script>
</body>
</html>
