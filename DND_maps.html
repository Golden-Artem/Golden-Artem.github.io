<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>D&D Map Maker — 0.6 версия</title>
<script src="https://unpkg.com/konva@9.3.1/konva.min.js"></script>
<style>
  :root { --left-w:200px; --right-w:200px; }
  html,body { margin:0; height:100%; background:#222; color:#eee; font-family:Arial, sans-serif; }
  .layout { display:flex; height:100vh; }
  .panel { background:#333; padding:12px; box-sizing:border-box; overflow:auto; }
  .left  { width:var(--left-w); }
  .right { width:var(--right-w); }
  #container { flex:1; background:#444; }

  h3 { margin:6px 0; font-size:15px; }
  .asset { padding:6px; margin-bottom:8px; background:#4b4b4b; border:1px solid #555; border-radius:6px; cursor:pointer; }
  .asset:hover { background:#5f5f5f; }
  .thumb { width:100%; height:auto; margin-top:6px; border-radius:4px; }

  .objItem { padding:6px; margin-bottom:6px; background:#4b4b4b; border:1px solid #555; border-radius:6px; cursor:pointer; }
  .objItem.active { background:#c8b56a; color:#000; }

  button, select, input[type=file] {
    width:100%; padding:8px; margin-top:8px;
    border:0; background:#5a5a5a; color:#fff; border-radius:6px; cursor:pointer;
  }
  button:hover, select:hover, input[type=file]:hover { background:#777; }

  .small { font-size:12px; color:#cfcfcf; margin-top:8px; }
  .info  { font-size:12px; color:#ddd; margin-top:10px; }
</style>
</head>
<body>
<div class="layout">

  <!-- Левая панель ассетов -->
  <div class="panel left">
    <h3>Ассеты</h3>
    <div id="assetList"></div>
    <input id="fileInput" type="file" accept="image/*">
    <button id="saveBtn">Сохранить карту (PNG)</button>
    <div class="small">Положите PNG в папку <code>assets/</code> или загружайте свои через «Выбрать файл».</div>
  </div>

  <!-- Сцена -->
  <div id="container"></div>

  <!-- Правая панель объектов/фона -->
  <div class="panel right">
    <h3>Объекты</h3>
    <div id="objects"></div>
    <button id="deleteBtn">Удалить выбранный</button>

    <h3 style="margin-top:14px;">Фон</h3>
    <select id="bgSelect">
      <option value="grid">Сетка (по умолчанию)</option>
      <option value="parchment">Пергамент</option>
      <option value="stone">Камень</option>
      <option value="sand">Песок</option>
    </select>
    <input id="bgFile" type="file" accept="image/*">
    <div class="info">Клик по пустому месту снимает выделение.  
    Повторный клик по объекту убирает рамку.  
    Колёсико над выделенным объектом изменяет только его размер.</div>
  </div>

</div>

<script>
/* ---------- Настройка ассетов ---------- */
const assets = [
  {name:'Деревянный дом', url:'assets/wood_house.png'},
  {name:'Каменный дом',   url:'assets/stone_house.png'},
  {name:'Замок',          url:'assets/castle.png'},
  {name:'Таверна',        url:'assets/tavern.png'},
  {name:'Гильдия',        url:'assets/guild.png'},
  {name:'Лес',            url:'assets/forest.png'},
  {name:'Поляна',         url:'assets/clearing.png'},
  // Подземелье
  {name:'Вход в подземелье', url:'assets/dungeon_entrance.png'},
  {name:'Комната подземелья', url:'assets/dungeon_room.png'},
  {name:'Сундук',            url:'assets/dungeon_chest.png'},
  {name:'Факел',             url:'assets/dungeon_torch.png'},
  {name:'Камни/руины',       url:'assets/dungeon_rocks.png'}
];

/* ---------- Сцена ---------- */
const leftW = 200, rightW = 200;
const stage = new Konva.Stage({
  container: 'container',
  width: window.innerWidth - (leftW + rightW),
  height: window.innerHeight
});
const bgLayer    = new Konva.Layer();
const gridLayer  = new Konva.Layer();
const objectLayer= new Konva.Layer();
stage.add(bgLayer);
stage.add(gridLayer);
stage.add(objectLayer);

/* Сетка */
function drawGrid(cell=48) {
  gridLayer.destroyChildren();
  const w = stage.width(), h = stage.height();
  for(let i=0;i<=w/cell;i++)
    gridLayer.add(new Konva.Line({points:[i*cell,0,i*cell,h], stroke:'#666', strokeWidth:1}));
  for(let j=0;j<=h/cell;j++)
    gridLayer.add(new Konva.Line({points:[0,j*cell,w,j*cell], stroke:'#666', strokeWidth:1}));
  gridLayer.batchDraw();
}
drawGrid();

/* Панель ассетов */
const assetList = document.getElementById('assetList');
assets.forEach(a=>{
  const d=document.createElement('div');
  d.className='asset';
  d.innerHTML=`<strong>${a.name}</strong><img class="thumb" src="${a.url}" alt="">`;
  d.onclick=()=>addAssetToMap(a.url,a.name,true);
  assetList.appendChild(d);
});

/* Объекты и трансформер */
let objectsData=[], selectedId=null, idCounter=1;
const transformer = new Konva.Transformer({
  rotateEnabled:false,
  enabledAnchors:[
    'top-left','top-center','top-right',
    'middle-right','bottom-right','bottom-center',
    'bottom-left','middle-left'
  ],
  boundBoxFunc:(oldB,newB)=>{
    if(newB.width<16||newB.height<16) return oldB;
    return newB;
  }
});
objectLayer.add(transformer);

function addAssetToMap(url,name,center){
  Konva.Image.fromURL(url,img=>{
    const w=img.width()||64,h=img.height()||64;
    const id='obj_'+(Date.now())+'_'+(idCounter++);
    img.setAttrs({
      x:center?stage.width()/2-w/4:stage.width()/2-32,
      y:center?stage.height()/2-h/4:stage.height()/2-32,
      width:w/2,height:h/2, draggable:true, id
    });
    img.on('click',e=>{e.cancelBubble=true;toggleSelect(id);});
    img.on('dragend transformend',refreshObjectList);
    objectLayer.add(img);
    objectsData.push({id,name,node:img});
    selectObject(id);
    refreshObjectList();
  });
}

const objectsDiv=document.getElementById('objects');
function refreshObjectList(){
  objectsDiv.innerHTML='';
  objectsData.forEach(o=>{
    const n=o.node, x=Math.round(n.x()), y=Math.round(n.y());
    const w=Math.round(n.width()*n.scaleX()), h=Math.round(n.height()*n.scaleY());
    const div=document.createElement('div');
    div.className='objItem'+(o.id===selectedId?' active':'');
    div.innerHTML=`<strong>${o.name}</strong>
      <div style="font-size:12px;">${x},${y} • ${w}×${h}</div>`;
    div.onclick=()=>toggleSelect(o.id);
    objectsDiv.appendChild(div);
  });
}

function selectObject(id){
  objectsData.forEach(o=>{o.node.strokeEnabled(false);o.node.shadowEnabled(false);});
  selectedId=id;
  const t=objectsData.find(o=>o.id===id);
  if(t){
    transformer.nodes([t.node]);
    t.node.strokeEnabled(true); t.node.stroke('yellow'); t.node.strokeWidth(3);
    t.node.shadowEnabled(true); t.node.shadowColor('black'); t.node.shadowBlur(6);
  } else transformer.nodes([]);
  objectLayer.batchDraw();
  refreshObjectList();
}
function toggleSelect(id){ selectedId===id?deselect():selectObject(id); }
function deselect(){
  if(!selectedId) return;
  const t=objectsData.find(o=>o.id===selectedId);
  if(t){ t.node.strokeEnabled(false); t.node.shadowEnabled(false); }
  selectedId=null; transformer.nodes([]); objectLayer.batchDraw(); refreshObjectList();
}
stage.on('mousedown',e=>{ if(e.target===stage||e.target===bgLayer) deselect(); });

/* Удаление */
document.getElementById('deleteBtn').onclick=()=>{
  if(!selectedId) return;
  const i=objectsData.findIndex(o=>o.id===selectedId);
  if(i>=0){ objectsData[i].node.destroy(); objectsData.splice(i,1); deselect(); refreshObjectList(); }
};

/* Колёсико: объект или сцена */
stage.on('wheel',e=>{
  e.evt.preventDefault();
  const ptr=stage.getPointerPosition();
  if(selectedId){
    const t=objectsData.find(o=>o.id===selectedId);
    if(t && stage.getIntersection(ptr)===t.node){
      const k=e.evt.deltaY>0?0.9:1.1;
      const s=t.node.scaleX()*k;
      if(s>0.1 && s<10){ t.node.scale({x:s,y:s}); objectLayer.batchDraw(); refreshObjectList(); }
      return;
    }
  }
  const scaleBy=1.1;
  const old=stage.scaleX();
  const mp={x:(ptr.x-stage.x())/old,y:(ptr.y-stage.y())/old};
  const dir=e.evt.deltaY>0?-1:1;
  const newS=dir>0?old*scaleBy:old/scaleBy;
  stage.scale({x:newS,y:newS});
  stage.position({x:ptr.x-mp.x*newS,y:ptr.y-mp.y*newS});
  stage.batchDraw();
});

/* Загрузка своего ассета */
document.getElementById('fileInput').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>addAssetToMap(ev.target.result,f.name,true);
  r.readAsDataURL(f);
  e.target.value='';
};

/* Сохранение */
document.getElementById('saveBtn').onclick=()=>{
  const uri=stage.toDataURL({pixelRatio:2});
  const a=document.createElement('a'); a.href=uri; a.download='dnd_map.png'; a.click();
};

/* ---------- Фоны ---------- */
const bgSelect=document.getElementById('bgSelect');
const bgFile=document.getElementById('bgFile');
const BG_URLS={
  parchment:'https://upload.wikimedia.org/wikipedia/commons/4/4d/Old_paper_texture_background.jpg',
  stone:'https://upload.wikimedia.org/wikipedia/commons/0/0b/Granite_texture_background.jpg',
  sand:'https://upload.wikimedia.org/wikipedia/commons/7/78/Sand_texture.jpg'
};

function setBackground(typeOrUrl){
  bgLayer.destroyChildren();
  if(!typeOrUrl||typeOrUrl==='grid'){ gridLayer.show(); bgLayer.batchDraw(); return; }
  const url = typeOrUrl.startsWith('data:') ? typeOrUrl : BG_URLS[typeOrUrl];
  if(!url) return;
  Konva.Image.fromURL(url,img=>{
    img.setAttrs({x:0,y:0,width:stage.width(),height:stage.height(),listening:false});
    bgLayer.add(img); bgLayer.moveToBottom(); bgLayer.batchDraw();
    gridLayer.moveToTop(); gridLayer.batchDraw();
  });
}
bgSelect.onchange=e=>{ const v=e.target.value; setBackground(v==='grid'?'grid':v); };
bgFile.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>setBackground(ev.target.result);
  r.readAsDataURL(f);
  e.target.value='';
};

/* Ресайз */
window.addEventListener('resize',()=>{
  stage.width(window.innerWidth-(leftW+rightW));
  stage.height(window.innerHeight);
  drawGrid();
  bgLayer.getChildren().each(img=>{img.width(stage.width()); img.height(stage.height());});
  bgLayer.batchDraw();
});
</script>
</body>
</html>

