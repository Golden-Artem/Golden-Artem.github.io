<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Лист персонажа — DnD</title>
<style>
  :root{
    --bg:#0f1720;
    --panel:#111821;
    --muted:#9aa6b2;
    --text:#e6eef6;
    --accent:#8ab4ff;
    --card:#0b1220;
    --accent-2:#ffd27a;
  }
  /* Light theme override (class .light) */
  :root.light{
    --bg:#f4f6f8;
    --panel:#ffffff;
    --muted:#475569;
    --text:#0b1220;
    --accent:#1976d2;
    --card:#ffffff;
    --accent-2:#f6b042;
  }

  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#051018);color:var(--text);}
  .app {
    display:flex;
    gap:12px;
    padding:12px;
    box-sizing:border-box;
    height:100vh;
  }

  /* left column (sheet) */
  .sheet {
    flex:1 1 720px;
    background:var(--panel);
    border-radius:10px;
    padding:12px;
    overflow:auto;
    box-shadow:0 6px 26px rgba(0,0,0,0.6);
  }
  .controls {
    display:flex;
    gap:8px;
    margin-bottom:10px;
    flex-wrap:wrap;
  }
  button, select, input[type="text"], input[type="file"]{
    background:var(--card);
    color:var(--text);
    border:1px solid rgba(255,255,255,0.04);
    padding:8px 10px;
    border-radius:8px;
    font-size:14px;
    outline:none;
  }
  button:hover{filter:brightness(1.06);cursor:pointer}
  .row {display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;}
  .field {display:flex; flex-direction:column; gap:6px; min-width:120px;}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], select{min-width:120px}

  .big-grid{
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:12px;
  }

  .panel-card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
    padding:10px; border-radius:8px;
    border:1px solid rgba(255,255,255,0.03);
  }

  /* stats block */
  .stats { display:flex; gap:8px; align-items:center; }
  .stat {
    width:64px; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; text-align:center;
  }
  .stat .val { font-size:20px; font-weight:700; }
  .stat .label { font-size:12px; color:var(--muted); }

  /* avatar canvas */
  .avatar-wrap { display:flex; flex-direction:column; gap:8px; align-items:center; }
  canvas#avatarCanvas { border-radius:8px; background:#0c1220; border:1px solid rgba(255,255,255,0.04); touch-action:none; width:200px; height:200px; }

  /* spells / sidebar */
  .sidebar { width:360px; display:flex; flex-direction:column; gap:10px; }
  .search-box { display:flex; gap:6px; }
  .list { max-height:54vh; overflow:auto; border-radius:8px; padding:6px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
  .list .item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px; border-radius:6px; margin-bottom:6px; background:rgba(255,255,255,0.01); }
  .list .item .meta{color:var(--muted);font-size:13px}
  .selected-list { background:rgba(0,0,0,0.06); padding:8px; border-radius:8px; max-height:26vh; overflow:auto; }

  /* modal */
  .modal {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.6); z-index:9999;
  }
  .modal.active { display:flex; }
  .modal .window { background:var(--panel); padding:18px; border-radius:10px; width:min(880px,95%); max-height:84vh; overflow:auto; border:1px solid rgba(255,255,255,0.03); }

  /* dice area */
  .dice-row { display:flex; gap:6px; align-items:center; margin-top:8px; }
  .dice-row button { min-width:56px; }

  /* small */
  @media (max-width:980px){
    .big-grid { grid-template-columns: 1fr; }
    .sidebar { width:100% }
  }

  /* light button */
  .theme-toggle { margin-left:auto; }

  /* help */
  .muted-note { color:var(--muted); font-size:13px; }

  /* tooltip-like description */
  .desc { font-size:14px; color:var(--muted); white-space:pre-wrap; margin-top:8px; }
</style>
</head>
<body>
<div class="app">
  <div class="sheet">
    <div class="controls">
      <button id="saveJsonBtn">Сохранить в JSON</button>
      <input id="loadJson" type="file" accept=".json" />
      <button id="clearBtn">Очистить лист</button>

      <label style="display:flex;align-items:center;gap:6px;margin-left:6px">
        <input type="checkbox" id="autoFill" checked/> Авто-заполнение
      </label>

      <div class="theme-toggle" style="margin-left:auto">
        <button id="toggleTheme">Тёмная тема</button>
      </div>
    </div>

    <div class="big-grid">
      <!-- main left sheet -->
      <div>
        <div class="row">
          <div class="field" style="flex:1;">
            <label>Имя персонажа</label>
            <input type="text" id="charName" placeholder="Имя" />
          </div>

          <div class="field">
            <label>Класс</label>
            <select id="classSelect"></select>
          </div>
          <div class="field">
            <label>Подкласс</label>
            <select id="subclassSelect"><option value="">—</option></select>
          </div>
          <div class="field">
            <label>Уровень</label>
            <input type="text" id="level" value="1"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Раса</label>
            <select id="raceSelect"></select>
          </div>

          <div class="field">
            <label>Фон</label>
            <input id="background" type="text"/>
          </div>

          <div style="flex:1" class="field">
            <label>Выбрать архетип/специальность (опционально)</label>
            <input id="customFeature" type="text" placeholder="Название способности (вручную)"/>
          </div>
        </div>

        <hr style="opacity:0.06">

        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="flex:1;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-size:13px;color:var(--muted)">Характеристики</div>
              </div>
              <div class="muted-note">Редактируйте вручную или используйте авто-заполнение</div>
            </div>

            <div class="stats" id="statsBlock" style="margin-top:8px;">
              <!-- stat blocks injected by JS -->
            </div>

            <div style="margin-top:12px;" class="panel-card">
              <div style="display:flex;gap:8px;align-items:center;">
                <div style="flex:1">
                  <label>Текущие ХП</label>
                  <input id="currentHP" type="text" />
                </div>
                <div style="width:120px">
                  <label>Класс брони</label>
                  <input id="ac" type="text" />
                </div>
                <div style="width:120px">
                  <label>Инициатива</label>
                  <input id="init" type="text" />
                </div>
              </div>

              <div style="margin-top:8px;">
                <label>Короткое описание персонажа</label>
                <textarea id="shortNote" rows="3" style="width:100%;border-radius:6px;padding:8px;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.03)"></textarea>
              </div>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px;">
              <div style="flex:1" class="panel-card">
                <label>Снаряжение</label>
                <div style="display:flex;gap:6px;margin-top:6px">
                  <input id="itemInput" type="text" placeholder="Добавить предмет вручную"/>
                  <button id="addItemBtn">Добавить</button>
                </div>
                <div id="itemList" class="selected-list" style="margin-top:8px"></div>
              </div>

              <div style="width:220px" class="panel-card">
                <label>Навыки/Особенности (поиск)</label>
                <div style="display:flex;gap:6px;margin-top:6px">
                  <input id="skillSearch" type="text" placeholder="Поиск навыка..." />
                  <button id="skillAddBtn">Добавить</button>
                </div>
                <div id="skillResults" class="list" style="margin-top:8px"></div>
              </div>
            </div>

            <div style="margin-top:10px" class="panel-card">
              <label>Дополнительные заметки / История</label>
              <textarea id="longNote" rows="6" style="width:100%;border-radius:6px;padding:8px;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.03)"></textarea>
            </div>

            <!-- dice -->
            <div style="margin-top:10px" class="panel-card">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>Кубики</div>
                <div class="muted-note">Нажмите — бросок появится ниже</div>
              </div>
              <div class="dice-row">
                <button class="diceBtn" data-sides="4">d4</button>
                <button class="diceBtn" data-sides="6">d6</button>
                <button class="diceBtn" data-sides="8">d8</button>
                <button class="diceBtn" data-sides="12">d12</button>
                <button class="diceBtn" data-sides="20">d20</button>
                <div id="diceResult" style="margin-left:auto;font-weight:700"></div>
              </div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;">
              <div class="panel-card" style="flex:1">
                <label>Заклинания/Фокусы (поиск)</label>
                <div style="display:flex; gap:6px; margin-top:6px;">
                  <input id="spellSearch" type="text" placeholder="Поиск заклинания..." />
                  <button id="spellSearchBtn">Поиск</button>
                </div>
                <div id="spellResults" class="list" style="margin-top:8px"></div>
                <div style="margin-top:8px">
                  <label>Выбранные заклинания</label>
                  <div id="chosenSpells" class="selected-list"></div>
                </div>
              </div>

              <div class="panel-card" style="width:220px">
                <label>Эффекты (поиск)</label>
                <div style="display:flex; gap:6px; margin-top:6px;">
                  <input id="effectSearch" type="text" placeholder="Поиск эффекта..." />
                  <button id="effectSearchBtn">Поиск</button>
                </div>
                <div id="effectResults" class="list" style="margin-top:8px"></div>
                <div style="margin-top:8px">
                  <label>Выбранные эффекты</label>
                  <div id="chosenEffects" class="selected-list"></div>
                </div>
              </div>
            </div>

          </div>

          <!-- right column: avatar + quick info -->
          <aside class="sidebar">
            <div class="panel-card avatar-wrap">
              <label>Аватар (зарузить или рисовать)</label>
              <canvas id="avatarCanvas" width="400" height="400"></canvas>
              <div style="display:flex;gap:6px;width:100%;flex-wrap:wrap;">
                <input id="avatarFile" type="file" accept="image/*">
                <button id="drawModeBtn">Рисовать</button>
                <button id="clearAvatarBtn">Очистить</button>
                <button id="downloadAvatarBtn">Скачать аватар</button>
              </div>
              <div style="display:flex;gap:6px;margin-top:6px;align-items:center;">
                <label>Кисть</label>
                <input id="brushSize" type="range" min="1" max="24" value="4">
                <label style="margin-left:auto">Цвет</label>
                <input id="brushColor" type="color" value="#ffffff">
              </div>
            </div>

            <div class="panel-card">
              <label>Классы / Подклассы / Раса</label>
              <div style="display:flex; gap:6px;">
                <div style="flex:1">
                  <div style="font-size:12px;color:var(--muted)">Класс</div>
                  <select id="classSideSelect"></select>
                </div>
                <div style="flex:1">
                  <div style="font-size:12px;color:var(--muted)">Подкласс</div>
                  <select id="subclassSideSelect"></select>
                </div>
              </div>
              <div style="margin-top:8px;">
                <div style="font-size:12px;color:var(--muted)">Раса</div>
                <select id="raceSideSelect"></select>
              </div>
            </div>

            <div class="panel-card">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>Сохранённые поля</div>
                <div class="muted-note">JSON</div>
              </div>
              <div style="margin-top:8px" id="quickJsonPreview" class="muted-note">—</div>
            </div>

            <div class="panel-card">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>Слушатели поиска</div>
                <div style="font-size:13px;color:var(--muted)">для диагностики</div>
              </div>
              <div id="logConsole" style="margin-top:6px; font-size:12px; color:var(--muted); max-height:12vh; overflow:auto;"></div>
            </div>
          </aside>
        </div>
      </div>

      <!-- right: lists and modal -->
      <div class="sidebar">
        <div class="panel-card">
          <label>База классов (демо)</label>
          <div id="classesList" class="list"></div>
        </div>

        <div class="panel-card">
          <label>База рас (демо)</label>
          <div id="racesList" class="list"></div>
        </div>

        <div class="panel-card">
          <label>База предметов (демо)</label>
          <div id="itemsList" class="list"></div>
        </div>

        <div class="panel-card">
          <label>База эффектов (демо)</label>
          <div id="effectsList" class="list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- modal for item/spell details -->
<div id="modal" class="modal">
  <div class="window">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div id="modalTitle" style="font-weight:700"></div>
      <div><button id="modalClose">Закрыть</button></div>
    </div>
    <div id="modalBody" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* -------------------------
   Demo data (replace or load from files via fetch)
   To load from files: fetch('spells.json').then(r=>r.json()).then(arr=>spells=arr). See comments below.
-------------------------*/
let classes = [
  {id:'fighter', name:'Воин', description:'Боец ближнего боя. Выносливый и смертоносный.'},
  {id:'wizard', name:'Волшебник', description:'Мастер арканных заклинаний, опирается на интеллект.'},
  {id:'rogue', name:'Плут', description:'Ловкий и скрытный, мастер приемов.'},
];
let subclasses = {
  'fighter': [{id:'champion', name:'Чемпион', desc:'Фокус на физической мощи.'},{id:'battle_master', name:'Боевой мастер', desc:'Тактические маневры.'}],
  'wizard': [{id:'evocation', name:'Эвокация', desc:'Сильные разрушительные заклинания.'},{id:'illusion', name:'Иллюзии', desc:'Запутывает разум врагов.'}],
  'rogue': [{id:'thief', name:'Вор', desc:'Мастер похищений и ловкости.'}]
};
let races = [
  {id:'human', name:'Человек', desc:' универсальная раса.'},
  {id:'elf', name:'Эльф', desc:'Минус к утомляемости, бонус к ловкости.'},
  {id:'dwarf', name:'Гном', desc:'Выносливые шахтеры.'}
];
let spells = [
  {id:'mage_hand', name:'Рука мага', level:0, school:'Conjuration', description:'Создаёт магическую руку...'},
  {id:'fireball', name:'Огненный шар', level:3, school:'Evocation', description:'Взрыв огня, наносящий урон в зоне.'},
  {id:'telekinesis', name:'Телекинез', level:5, school:'Transmutation', description:'Позволяет двигать объекты силой мысли.'}
];
let items = [
  {id:'potion_heal', name:'Зелье исцеления', descr:'Восстанавливает HP.'},
  {id:'rope', name:'Верёвка 50 ft', descr:'Прочная верёвка.'}
];
let effects = [
  {id:'blinded', name:'Ослеплён', descr:'Не видит, атаки с преимуществом по нему.'},
  {id:'poisoned', name:'Отравлен', descr:'Минусы к проверкам и спасброскам.'}
];
let skills = [
  {id:'acrobatics', name:'Акробатика'},
  {id:'arcana', name:'Аркана'},
  {id:'stealth', name:'Скрытность'}
];

/* If you want to load external JSON files hosted (eg. on GitHub Pages),
   uncomment and use something like:
fetch('https://yourdomain.com/data/spells.json').then(r=>r.json()).then(arr => {spells = arr; renderSpellIndex();});
*/

/* -------------------------
   App state
-------------------------*/
const state = {
  character: {
    name:'', classId:'', subclassId:'', level:1, race:'', stats:{:10,DEX:10,CON:10,INT:10,WIS:10,CHA:10},
    hp:0, ac:10, init:0, spells:[], items:[], effects:[], skills:[]
  },
  drawing:false
};

/* -------------------------
   Init DOM refs
-------------------------*/
const classSelect = document.getElementById('classSelect');
const subclassSelect = document.getElementById('subclassSelect');
const raceSelect = document.getElementById('raceSelect');
const classSideSelect = document.getElementById('classSideSelect');
const subclassSideSelect = document.getElementById('subclassSideSelect');
const raceSideSelect = document.getElementById('raceSideSelect');

const saveJsonBtn = document.getElementById('saveJsonBtn');
const loadJson = document.getElementById('loadJson');
const clearBtn = document.getElementById('clearBtn');
const autoFill = document.getElementById('autoFill');

const itemInput = document.getElementById('itemInput');
const addItemBtn = document.getElementById('addItemBtn');
const itemList = document.getElementById('itemList');

const spellSearch = document.getElementById('spellSearch');
const spellSearchBtn = document.getElementById('spellSearchBtn');
const spellResults = document.getElementById('spellResults');
const chosenSpells = document.getElementById('chosenSpells');

const effectSearch = document.getElementById('effectSearch');
const effectSearchBtn = document.getElementById('effectSearchBtn');
const effectResults = document.getElementById('effectResults');
const chosenEffects = document.getElementById('chosenEffects');

const skillSearch = document.getElementById('skillSearch');
const skillAddBtn = document.getElementById('skillAddBtn');
const skillResults = document.getElementById('skillResults');

const modal = document.getElementById('modal');
const modalClose = document.getElementById('modalClose');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

const avatarCanvas = document.getElementById('avatarCanvas');
const avatarFile = document.getElementById('avatarFile');
const drawModeBtn = document.getElementById('drawModeBtn');
const clearAvatarBtn = document.getElementById('clearAvatarBtn');
const downloadAvatarBtn = document.getElementById('downloadAvatarBtn');
const brushSize = document.getElementById('brushSize');
const brushColor = document.getElementById('brushColor');

const diceBtns = document.querySelectorAll('.diceBtn');
const diceResult = document.getElementById('diceResult');

const classListDiv = document.getElementById('classesList');
const racesListDiv = document.getElementById('racesList');
const itemsListDiv = document.getElementById('itemsList');
const effectsListDiv = document.getElementById('effectsList');

const logConsole = document.getElementById('logConsole');
const quickJsonPreview = document.getElementById('quickJsonPreview');

/* -------------------------
   Helpers
-------------------------*/
function log(msg){
  const el = document.createElement('div');
  el.textContent = `[${new Date().toLocaleTimeing()}] ${msg}`;
  logConsole.prepend(el);
}
function download(filename, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
  a.download = filename; a.click();
}
function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modal.classList.add('active');
}
function closeModal(){ modal.classList.remove('active'); }

/* -------------------------
   Render / UI sync
-------------------------*/
function renderClassOptions(){
  classSelect.innerHTML = '<option value="">—</option>';
  classSideSelect.innerHTML = '<option value="">—</option>';
  classes.forEach(c=>{
    const o = document.createElement('option'); o.value=c.id; o.textContent=c.name; classSelect.appendChild(o);
    const o2 = o.cloneNode(true); classSideSelect.appendChild(o2);
  });
  renderSubclassOptions();
}
function renderSubclassOptions(){
  const cls = classSelect.value || classSideSelect.value;
  subclassSelect.innerHTML = '<option value="">—</option>';
  subclassSideSelect.innerHTML = '<option value="">—</option>';
  if(!cls || !subclasses[cls]) return;
  subclasses[cls].forEach(s=>{
    const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; subclassSelect.appendChild(o);
    const o2=o.cloneNode(true); subclassSideSelect.appendChild(o2);
  });
}
function renderRaceOptions(){
  raceSelect.innerHTML = '<option value="">—</option>';
  raceSideSelect.innerHTML = '<option value="">—</option>';
  races.forEach(r=>{
    const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; raceSelect.appendChild(o);
    const o2=o.cloneNode(true); raceSideSelect.appendChild(o2);
  });
}
function renderStatBlocks(){
  const stats = ['','DEX','CON','INT','WIS','CHA'];
  const container = document.getElementById('statsBlock');
  container.innerHTML = '';
  stats.forEach(s=>{
    const val = state.character.stats[s] ?? 10;
    const div = document.createElement('div');
    div.className='stat';
    div.innerHTML = `<div class="val"><input data-stat="${s}" class="statInput" style="background:transparent;border:0;color:var(--text);width:48px;text-align:center;font-weight:700" value="${val}"></div><div class="label">${s}</div>`;
    container.appendChild(div);
  });
  // attach listeners
  document.querySelectorAll('.statInput').forEach(inp=>{
    inp.addEventListener('input', (e)=>{
      const st=e.target.dataset.stat;
      const v = parseInt(e.target.value) || 0;
      state.character.stats[st]=v;
      syncQuickPreview();
    });
  });
}
function renderIndexLists(){
  classListDiv.innerHTML=''; classes.forEach(c=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div>${c.name}</div><div class="meta"><button data-class="${c.id}" class="inspectClass">i</button></div>`; classListDiv.appendChild(d);});
  racesListDiv.innerHTML=''; races.forEach(r=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div>${r.name}</div><div class="meta"><button data-race="${r.id}" class="inspectRace">i</button></div>`; racesListDiv.appendChild(d);});
  itemsListDiv.innerHTML=''; items.forEach(it=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div>${it.name}</div><div class="meta"><button data-item="${it.id}" class="inspectItem">i</button></div>`; itemsListDiv.appendChild(d);});
  effectsListDiv.innerHTML=''; effects.forEach(it=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div>${it.name}</div><div class="meta"><button data-effect="${it.id}" class="inspectEffect">i</button></div>`; effectsListDiv.appendChild(d);});
}

/* chosen lists rendering */
function renderChosenItems(){
  itemList.innerHTML='';
  state.character.items.forEach((it, idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div>${it}</div><div class="meta"><button data-idx="${idx}" class="removeItem">×</button></div>`;
    itemList.appendChild(div);
  });
  document.querySelectorAll('.removeItem').forEach(b=>b.onclick=(e)=>{ const i=+e.target.dataset.idx; state.character.items.splice(i,1); renderChosenItems(); syncQuickPreview(); });
}
function renderChosenSpells(){
  chosenSpells.innerHTML='';
  state.character.spells.forEach((s, idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div>${s.name} (уровень ${s.level})</div><div class="meta"><button data-idx="${idx}" class="spellInfo">i</button><button data-idx="${idx}" class="removeSpell">×</button></div>`;
    chosenSpells.appendChild(div);
  });
  document.querySelectorAll('.removeSpell').forEach(b=>b.onclick=(e)=>{ const i=+e.target.dataset.idx; state.character.spells.splice(i,1); renderChosenSpells(); syncQuickPreview(); });
  document.querySelectorAll('.spellInfo').forEach(b=>b.onclick=(e)=>{ const i=+e.target.dataset.idx; const sp=state.character.spells[i]; openModal(sp.name, `<ong>Школа:</ong> ${sp.school||'-'}<br><ong>Уровень:</ong> ${sp.level}<hr>${sp.description}`) });
}
function renderChosenEffects(){
  chosenEffects.innerHTML='';
  state.character.effects.forEach((ef, idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div>${ef.name}</div><div class="meta"><button data-idx="${idx}" class="effectInfo">i</button><button data-idx="${idx}" class="removeEffect">×</button></div>`;
    chosenEffects.appendChild(div);
  });
  document.querySelectorAll('.removeEffect').forEach(b=>b.onclick=(e)=>{ const i=+e.target.dataset.idx; state.character.effects.splice(i,1); renderChosenEffects(); syncQuickPreview(); });
  document.querySelectorAll('.effectInfo').forEach(b=>b.onclick=(e)=>{ const i=+e.target.dataset.idx; const sp=state.character.effects[i]; openModal(sp.name, `${sp.descr||''}`) });
}
function renderSkillResults(list){
  skillResults.innerHTML='';
  list.forEach(s=>{
    const el=document.createElement('div'); el.className='item'; el.innerHTML=`<div>${s.name}</div><div class="meta"><button data-skill="${s.id}" class="addSkill">Добавить</button></div>`;
    skillResults.appendChild(el);
  });
  document.querySelectorAll('.addSkill').forEach(b=>b.onclick=(e)=>{ const id=e.target.dataset.skill; const sk=skills.find(x=>x.id===id); if(!sk) return; if(!state.character.skills.some(x=>x.id===id)) state.character.skills.push(sk); renderSkillList(); syncQuickPreview(); });
}
function renderSkillList(){
  const node=document.getElementById('skillResults');
  // show current skills
  let html='';
  state.character.skills.forEach((s,idx)=> html += `<div class="item"><div>${s.name}</div><div class="meta"><button data-idx="${idx}" class="removeSkill">×</button></div></div>`);
  node.innerHTML = html || '<div class="muted-note">Нет навыков</div>';
  document.querySelectorAll('.removeSkill').forEach(b=>b.onclick=(e)=>{ const i=+e.target.dataset.idx; state.character.skills.splice(i,1); renderSkillList(); syncQuickPreview(); });
}

function renderSpellSearchResults(list){
  spellResults.innerHTML='';
  list.forEach(s=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML = `<div><ong>${s.name}</ong><div style="font-size:12px;color:var(--muted)">${s.school||''} • уровень ${s.level}</div></div><div class="meta"><label><input type="checkbox" data-spell="${s.id}" ${state.character.spells.some(x=>x.id===s.id)?'checked':''}/>Добавить</label><button data-spell="${s.id}" class="inspectSpell">i</button></div>`;
    spellResults.appendChild(row);
  });
  // checkbox handlers
  document.querySelectorAll('input[type="checkbox"][data-spell]').forEach(cb=>{
    cb.onchange = (e)=>{
      const id = e.target.dataset.spell;
      const sp = spells.find(x=>x.id===id);
      if(!sp) return;
      if(e.target.checked){
        if(!state.character.spells.some(x=>x.id===id)) state.character.spells.push(sp);
      } else {
        state.character.spells = state.character.spells.filter(x=>x.id!==id);
      }
      renderChosenSpells(); syncQuickPreview();
    };
  });
  document.querySelectorAll('.inspectSpell').forEach(b=>b.onclick=(e)=>{ const id=e.target.dataset.spell; const sp=spells.find(x=>x.id===id); if(sp) openModal(sp.name, `<ong>Школа:</ong> ${sp.school||'-'}<br><ong>Уровень:</ong> ${sp.level}<hr>${sp.description}`) });
}

function renderEffectSearchResults(list){
  effectResults.innerHTML='';
  list.forEach(s=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML = `<div><ong>${s.name}</ong><div style="font-size:12px;color:var(--muted)">${s.descr? s.descr.slice(0,60)+'…':''}</div></div><div class="meta"><label><input type="checkbox" data-effect="${s.id}" ${state.character.effects.some(x=>x.id===s.id)?'checked':''}/>Добавить</label><button data-effect="${s.id}" class="inspectEffectBtn">i</button></div>`;
    effectResults.appendChild(row);
  });
  document.querySelectorAll('input[type="checkbox"][data-effect]').forEach(cb=>{
    cb.onchange = (e)=>{
      const id = e.target.dataset.effect;
      const ef = effects.find(x=>x.id===id);
      if(!ef) return;
      if(e.target.checked){
        if(!state.character.effects.some(x=>x.id===id)) state.character.effects.push(ef);
      } else {
        state.character.effects = state.character.effects.filter(x=>x.id!==id);
      }
      renderChosenEffects(); syncQuickPreview();
    };
  });
  document.querySelectorAll('.inspectEffectBtn').forEach(b=>b.onclick=(e)=>{ const id=e.target.dataset.effect; const sp=effects.find(x=>x.id===id); if(sp) openModal(sp.name, `${sp.descr||''}`) });
}

/* quick preview */
function syncQuickPreview(){
  const s = state.character;
  quickJsonPreview.textContent = `${s.name || '—'} • ${s.classId||''} ${s.subclassId?'/'+s.subclassId:''} • ${s.race||''}`;
  // also update side selects if user changed main selects
  classSideSelect.value = s.classId;
  subclassSideSelect.value = s.subclassId;
  raceSideSelect.value = s.race;
}

/* -------------------------
   Events wiring
-------------------------*/
document.addEventListener('DOMContentLoaded', ()=>{
  renderClassOptions();
  renderRaceOptions();
  renderStatBlocks();
  renderIndexLists();
  renderSkillResults(skills.slice(0,10));
  renderSpellSearchResults(spells);
  renderEffectSearchResults(effects);
  renderChosenSpells();
  renderChosenEffects();
  renderSkillList();
  renderChosenItems();
  syncQuickPreview();
  log('Готово. UI загружен.');
});

/* class/subclass wiring: change both selects when either side changed */
classSelect.onchange = (e)=>{
  state.character.classId = e.target.value;
  renderSubclassOptions();
  syncQuickPreview();
};
classSideSelect.onchange = (e)=>{
  state.character.classId = e.target.value;
  classSelect.value = e.target.value;
  renderSubclassOptions();
  syncQuickPreview();
};
subclassSelect.onchange = (e)=>{ state.character.subclassId = e.target.value; subclassSideSelect.value=e.target.value; syncQuickPreview(); };
subclassSideSelect.onchange = (e)=>{ state.character.subclassId=e.target.value; subclassSelect.value=e.target.value; syncQuickPreview(); };

raceSelect.onchange = (e)=>{ state.character.race = e.target.value; raceSideSelect.value=e.target.value; syncQuickPreview(); };
raceSideSelect.onchange = (e)=>{ state.character.race = e.target.value; raceSelect.value=e.target.value; syncQuickPreview(); };

document.getElementById('charName').addEventListener('input', (e)=>{ state.character.name = e.target.value; syncQuickPreview(); });

/* items */
addItemBtn.onclick = ()=>{
  const v = itemInput.value.trim();
  if(!v) return;
  state.character.items.push(v);
  itemInput.value='';
  renderChosenItems();
  syncQuickPreview();
};

/* spells search */
spellSearchBtn.onclick = ()=>{
  const q = spellSearch.value.trim().toLowerCase();
  const res = spells.filter(s => s.name.toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q));
  renderSpellSearchResults(res);
};

/* effects search */
effectSearchBtn.onclick = ()=>{
  const q = effectSearch.value.trim().toLowerCase();
  const res = effects.filter(s => s.name.toLowerCase().includes(q) || (s.descr||'').toLowerCase().includes(q));
  renderEffectSearchResults(res);
};

/* skill search */
skillAddBtn.onclick = ()=>{
  const q = skillSearch.value.trim().toLowerCase();
  const res = skills.filter(s => s.name.toLowerCase().includes(q) || s.id.toLowerCase().includes(q));
  renderSkillResults(res.length?res:skills.slice(0,10));
};

/* save / load / clear */
saveJsonBtn.onclick = ()=>{
  // build export object
  const exportObj = {
    meta:{version:'v1'},
    character: state.character,
    notes:{
      short: document.getElementById('shortNote').value,
      long: document.getElementById('longNote').value
    }
  };
  download('character.json', JSON.ingify(exportObj, null, 2));
};

loadJson.onchange = (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    try{
      const obj = JSON.parse(ev.target.result);
      if(obj.character){
        Object.assign(state.character, obj.character);
        // update UI values
        document.getElementById('charName').value = state.character.name||'';
        document.getElementById('level').value = state.character.level||1;
        renderStatBlocks();
        renderChosenSpells();
        renderChosenEffects();
        renderChosenItems();
        renderSkillList();
        syncQuickPreview();
        log('Файл загружен.');
      } else {
        alert('Неверный формат JSON.');
      }
    }catch(err){ alert('Ошибка чтения JSON: '+err.message) }
  };
  r.readAsText(f);
  e.target.value='';
};

/* clear sheet */
clearBtn.onclick = ()=>{
  if(!confirm('Очистить лист персонажа?')) return;
  state.character = {name:'', classId:'', subclassId:'', level:1, race:'', stats:{Сила:10,Ловкость:10,Выносливость:10,Интеллект:10,Мудрость:10,Харизма:10}, hp:0, ac:10, init:0, spells:[], items:[], effects:[], skills:[]};
  document.getElementById('charName').value='';
  document.getElementById('shortNote').value='';
  document.getElementById('longNote').value='';
  renderStatBlocks(); renderChosenSpells(); renderChosenEffects(); renderChosenItems(); renderSkillList(); syncQuickPreview();
  // clear avatar
  clearAvatar();
  log('Лист очищен.');
};

/* inspect buttons in side lists */
document.body.addEventListener('click', (e)=>{
  if(e.target.matches('.inspectClass')){
    const id=e.target.dataset.class; const c=classes.find(x=>x.id===id); if(c) openModal(c.name, c.description);
  } else if(e.target.matches('.inspectRace')){
    const id=e.target.dataset.race; const c=races.find(x=>x.id===id); if(c) openModal(c.name, c.desc);
  } else if(e.target.matches('.inspectItem')){
    const id=e.target.dataset.item; const c=items.find(x=>x.id===id); if(c) openModal(c.name, c.descr||'');
  } else if(e.target.matches('.inspectEffect')){
    const id=e.target.dataset.effect; const c=effects.find(x=>x.id===id); if(c) openModal(c.name, c.descr||'');
  }
});

/* modal close */
modalClose.onclick = closeModal;
modal.onclick = (e)=>{ if(e.target===modal) closeModal(); };

/* dice */
diceBtns.forEach(btn=>{
  btn.onclick = ()=>{
    const sides = +btn.dataset.sides;
    const val = 1 + Math.floor(Math.random()*sides);
    diceResult.textContent = `d${sides} → ${val}`;
  };
});

/* avatar drawing/upload */
const ctx = avatarCanvas.getContext('2d');
let drawing=false; let last=null; let brush=4; let color='#ffffff';
function clearAvatar(){ ctx.clearRect(0,0,avatarCanvas.width, avatarCanvas.height); log('Аватар очищен'); }
clearAvatar();

avatarFile.onchange = (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    const img = new Image();
    img.onload = ()=>{ // draw centered and scaled
      ctx.clearRect(0,0,avatarCanvas.width, avatarCanvas.height);
      const ratio = Math.min(avatarCanvas.width/img.width, avatarCanvas.height/img.height);
      const w = img.width*ratio, h=img.height*ratio;
      ctx.drawImage(img, (avatarCanvas.width-w)/2, (avatarCanvas.height-h)/2, w,h);
    };
    img.src = ev.target.result;
  };
  r.readAsDataURL(f);
  e.target.value='';
};

drawModeBtn.onclick = ()=>{
  state.drawing = !state.drawing;
  drawModeBtn.textContent = state.drawing ? 'Рисование: ВКЛ' : 'Рисовать';
  log('Режим рисования: ' + (state.drawing?'вкл':'выкл'));
};
clearAvatarBtn.onclick = clearAvatar;
downloadAvatarBtn.onclick = ()=>{ const data=avatarCanvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download='avatar.png'; a.click(); };

brushSize.oninput = ()=> brush=+brushSize.value;
brushColor.oninput = ()=> color=brushColor.value;

function getCanvasPos(e){
  const rect=avatarCanvas.getBoundingClientRect();
  if(e.touches && e.touches[0]) {
    return {x:(e.touches[0].clientX-rect.left)*(avatarCanvas.width/rect.width), y:(e.touches[0].clientY-rect.top)*(avatarCanvas.height/rect.height)};
  }
  return {x:(e.clientX-rect.left)*(avatarCanvas.width/rect.width), y:(e.clientY-rect.top)*(avatarCanvas.height/rect.height)};
}

avatarCanvas.addEventListener('pointerdown', (e)=>{
  if(!state.drawing) return;
  drawing=true; last = getCanvasPos(e);
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.strokeStyle=color; ctx.lineWidth=brush;
  ctx.beginPath(); ctx.moveTo(last.x,last.y);
  e.preventDefault();
});
avatarCanvas.addEventListener('pointermove', (e)=>{
  if(!drawing || !state.drawing) return;
  const p = getCanvasPos(e);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
  last=p;
});
window.addEventListener('pointerup', ()=>{ if(drawing) { drawing=false; ctx.closePath(); } });

/* drawing supports touch as pointer events; prevents scrolling while drawing on mobile */
avatarCanvas.addEventListener('touchstart', e=>{ if(state.drawing) e.preventDefault(); }, {passive:false});

/* spell/effect search quick filter on enter */
spellSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') spellSearchBtn.click();});
effectSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') effectSearchBtn.click();});
skillSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') skillAddBtn.click();});

/* auto-fill example: fill stats when class selected */
classSelect.addEventListener('change', ()=>{
  if(!autoFill.checked) return;
  const cid = classSelect.value;
  if(cid==='fighter'){
    state.character.stats = {STR:16,DEX:12,CON:14,INT:8,WIS:10,CHA:10};
  } else if(cid==='wizard'){
    state.character.stats = {STR:8,DEX:12,CON:12,INT:16,WIS:10,CHA:10};
  } else if(cid==='rogue'){
    state.character.stats = {STR:10,DEX:16,CON:12,INT:12,WIS:10,CHA:10};
  } else {
    state.character.stats = {STR:10,DEX:10,CON:10,INT:10,WIS:10,CHA:10};
  }
  renderStatBlocks();
  syncQuickPreview();
});

/* theme toggle */
const toggleThemeBtn = document.getElementById('toggleTheme');
toggleThemeBtn.onclick = ()=>{
  document.documentElement.classList.toggle('light');
  toggleThemeBtn.textContent = document.documentElement.classList.contains('light')? 'Светлая тема':'Тёмная тема';
};

/* click handlers for demo index items to add them quickly */
classListDiv.addEventListener('click', (e)=>{
  if(e.target.matches('button[data-class]')) return;
  const node = e.target.closest('.item'); if(!node) return;
  const text = node.querySelector('div').textContent;
  document.getElementById('charName').value = text + ' — тест';
  state.character.name = document.getElementById('charName').value;
  syncQuickPreview();
});
itemsListDiv.addEventListener('click', (e)=>{
  if(e.target.matches('button')) return;
  const node = e.target.closest('.item'); if(!node) return;
  const text = node.querySelector('div').textContent;
  state.character.items.push(text);
  renderChosenItems(); syncQuickPreview();
});

/* log quick actions */
document.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>log('Нажата кнопка: '+(b.textContent||b.id))));

/* initial populate selectable lists */
renderClassOptions(); renderRaceOptions(); renderIndexLists();

/* -------------------------
   End
-------------------------*/
</script>
</body>
</html>
